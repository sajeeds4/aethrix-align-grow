<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin ‚Üí Website Sync Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .panel h2::before {
            content: 'üë®‚Äçüíº';
            font-size: 1.5em;
        }
        .panel.careers h2::before {
            content: 'üåê';
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .instructions {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            color: #004085;
            margin-bottom: 10px;
        }
        .instructions ol {
            margin-left: 20px;
        }
        .instructions li {
            margin: 8px 0;
            line-height: 1.6;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button.primary {
            background: #667eea;
            color: white;
        }
        button.secondary {
            background: #48bb78;
            color: white;
        }
        button.danger {
            background: #f56565;
            color: white;
        }
        .job-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        .job-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .job-item.updated {
            animation: pulse 0.5s;
            border-left-color: #48bb78;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .job-item.new {
            animation: slideIn 0.5s, pulse 0.5s;
            border-left-color: #4299e1;
        }
        .job-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }
        .job-meta {
            font-size: 14px;
            color: #718096;
        }
        .sync-indicator {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .sync-arrow {
            font-size: 3em;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }
        .timer {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .highlight {
            background: #ffd700;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Admin Panel ‚ÜîÔ∏è Website Sync Test</h1>

        <div class="sync-indicator">
            <div class="sync-arrow">‚Üí ‚Üí ‚Üí</div>
            <p style="margin-top: 10px; font-size: 18px; color: #718096;">
                Changes in Admin Panel should appear here in <span class="timer">1-2</span> seconds
            </p>
        </div>

        <div class="instructions">
            <h3>üß™ Quick Test Instructions:</h3>
            <ol>
                <li><strong>Keep this page open</strong></li>
                <li>Open <strong>Admin Panel</strong> in another tab: 
                    <code>http://localhost:8080/sap-admin</code>
                </li>
                <li>Login and go to <strong>"Job Management"</strong> tab</li>
                <li>Click <strong>"Edit"</strong> on any job</li>
                <li>Change the <span class="highlight">salary</span> or <span class="highlight">title</span></li>
                <li>Click <strong>"Save"</strong></li>
                <li><strong>Watch this page!</strong> The job should update automatically within 2 seconds ‚ö°</li>
            </ol>
        </div>

        <div class="test-grid">
            <div class="panel">
                <h2>Admin Panel Status</h2>
                <div id="admin-status" class="status pending">
                    ‚è≥ Waiting for you to open Admin Panel...
                </div>
                <p>Open in another tab:</p>
                <div class="button-group">
                    <button class="primary" onclick="window.open('http://localhost:8080/sap-admin', '_blank')">
                        üöÄ Open Admin Panel
                    </button>
                </div>
            </div>

            <div class="panel careers">
                <h2>Website (Careers Page)</h2>
                <div id="careers-status" class="status pending">
                    üîå Connecting to database...
                </div>
                <p>This simulates your public website</p>
            </div>
        </div>

        <div class="panel">
            <h2>üìã Live Job Listings (Auto-Updating)</h2>
            <p style="margin-bottom: 15px; color: #718096;">
                These jobs will automatically update when you edit them in Admin Panel:
            </p>
            <div id="job-list" class="job-list">
                <p style="text-align: center; color: #718096;">Loading jobs...</p>
            </div>
            <div class="button-group">
                <button class="secondary" onclick="loadJobs()">
                    üîÑ Refresh Jobs
                </button>
                <button class="primary" onclick="window.open('http://localhost:8080/careers', '_blank')">
                    üåê View Real Careers Page
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://faoiscbbfjtvpywmddpn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhb2lzY2JiZmp0dnB5d21kZHBuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5NDgyNzUsImV4cCI6MjA3NDUyNDI3NX0.crp_UbafreGGA_9H9berxsNYzUSijPzOuAQtC6jT044';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let jobs = [];
        let lastUpdateTime = null;

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.innerHTML = message;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        async function loadJobs() {
            try {
                const { data, error } = await supabaseClient
                    .from('job_listings')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                jobs = data || [];
                renderJobs();
                
                updateStatus('careers-status', '‚úÖ Connected! Watching for updates...', 'success');
            } catch (error) {
                console.error('Error loading jobs:', error);
                updateStatus('careers-status', '‚ùå Error loading jobs: ' + error.message, 'error');
            }
        }

        function renderJobs(updatedJobId = null, isNew = false) {
            const jobList = document.getElementById('job-list');
            
            if (jobs.length === 0) {
                jobList.innerHTML = '<p style="text-align: center; color: #718096;">No jobs found. Create one in Admin Panel!</p>';
                return;
            }

            jobList.innerHTML = jobs.map(job => {
                const isUpdated = job.id === updatedJobId;
                const classes = isUpdated ? (isNew ? 'job-item new' : 'job-item updated') : 'job-item';
                
                return `
                    <div class="${classes}" id="job-${job.id}">
                        <div class="job-title">
                            ${isUpdated ? (isNew ? '‚ú® NEW: ' : 'üîÑ UPDATED: ') : ''}
                            ${job.title}
                        </div>
                        <div class="job-meta">
                            üìç ${job.location} | üíº ${job.employment_type} | üí∞ ${job.salary_range || 'Not specified'}
                        </div>
                        <div class="job-meta" style="margin-top: 5px; font-size: 12px;">
                            Updated: ${formatDate(job.created_at)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Subscribe to realtime changes
        const channel = supabaseClient
            .channel('admin_test_sync')
            .on(
                'postgres_changes',
                {
                    event: '*',
                    schema: 'public',
                    table: 'job_listings'
                },
                (payload) => {
                    console.log('üî• Realtime event received:', payload);
                    
                    const eventType = payload.eventType;
                    const jobId = payload.new?.id || payload.old?.id;
                    
                    if (eventType === 'INSERT') {
                        updateStatus('admin-status', '‚úÖ New job created! Syncing...', 'success');
                        jobs.unshift(payload.new);
                        renderJobs(jobId, true);
                    } else if (eventType === 'UPDATE') {
                        updateStatus('admin-status', '‚úÖ Job updated! Syncing...', 'success');
                        const index = jobs.findIndex(j => j.id === jobId);
                        if (index !== -1) {
                            jobs[index] = payload.new;
                            renderJobs(jobId, false);
                        }
                    } else if (eventType === 'DELETE') {
                        updateStatus('admin-status', '‚úÖ Job deleted! Syncing...', 'success');
                        jobs = jobs.filter(j => j.id !== jobId);
                        renderJobs();
                    }
                    
                    // Show success message temporarily
                    setTimeout(() => {
                        updateStatus('admin-status', 'üë®‚Äçüíº Waiting for next admin action...', 'pending');
                    }, 3000);

                    // Calculate sync time
                    if (lastUpdateTime) {
                        const syncTime = ((Date.now() - lastUpdateTime) / 1000).toFixed(1);
                        console.log(`‚ö° Sync time: ${syncTime}s`);
                    }
                    lastUpdateTime = Date.now();
                }
            )
            .subscribe((status) => {
                console.log('Subscription status:', status);
                
                if (status === 'SUBSCRIBED') {
                    updateStatus('careers-status', '‚úÖ Live sync active! Ready to receive updates...', 'success');
                    loadJobs();
                } else if (status === 'CHANNEL_ERROR') {
                    updateStatus('careers-status', '‚ùå Realtime connection failed!', 'error');
                } else if (status === 'TIMED_OUT') {
                    updateStatus('careers-status', '‚è±Ô∏è Connection timeout!', 'error');
                }
            });

        // Initial load
        console.log('üöÄ Admin ‚Üí Website Sync Test Started');
        console.log('Make changes in Admin Panel to see them appear here!');
    </script>
</body>
</html>
