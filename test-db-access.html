<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Access Test - Aethrix</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
        }
        h2 {
            color: #1e40af;
            margin-top: 0;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #1e40af;
        }
        .success {
            color: #059669;
            font-weight: bold;
        }
        .error {
            color: #dc2626;
            font-weight: bold;
        }
        .info {
            color: #0891b2;
        }
        pre {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success {
            background: #d1fae5;
            color: #059669;
        }
        .status.error {
            background: #fee2e2;
            color: #dc2626;
        }
        .status.warning {
            background: #fef3c7;
            color: #d97706;
        }
        .input-group {
            margin: 10px 0;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            max-width: 300px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <h1>üîç Aethrix Database Access Diagnostic Tool</h1>
    <p><strong>Purpose:</strong> Test if your database is accessible and RLS policies are working correctly</p>

    <!-- Auth Section -->
    <div class="test-section">
        <h2>üîê Step 1: Authentication Status</h2>
        <div id="auth-status">Checking...</div>
        <div id="auth-info" style="margin-top: 10px;"></div>
        
        <div style="margin-top: 15px;">
            <div class="input-group">
                <label>Email:</label>
                <input type="email" id="email" placeholder="admin@example.com" value="admin@example.com">
            </div>
            <div class="input-group">
                <label>Password:</label>
                <input type="password" id="password" placeholder="Enter password" value="admin123">
            </div>
            <button onclick="login()">Login</button>
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Connection Test -->
    <div class="test-section">
        <h2>üîå Step 2: Basic Connection</h2>
        <button onclick="testConnection()">Test Connection</button>
        <div id="connection-result"></div>
    </div>

    <!-- Job Listings Test (Public) -->
    <div class="test-section">
        <h2>üìã Step 3: Fetch Jobs (Public Access)</h2>
        <p class="info">Tests if anonymous users can view active jobs</p>
        <button onclick="testFetchJobs()">Fetch Active Jobs</button>
        <div id="jobs-result"></div>
    </div>

    <!-- Job Listings Test (Authenticated) -->
    <div class="test-section">
        <h2>üîí Step 4: Fetch All Jobs (Authenticated)</h2>
        <p class="info">Tests if logged-in admin can view all jobs</p>
        <button onclick="testFetchAllJobs()">Fetch All Jobs (Admin)</button>
        <div id="all-jobs-result"></div>
    </div>

    <!-- Create Job Test -->
    <div class="test-section">
        <h2>‚ûï Step 5: Create Job (Authenticated)</h2>
        <p class="info">Tests if logged-in admin can post new jobs</p>
        <button onclick="testCreateJob()">Create Test Job</button>
        <div id="create-job-result"></div>
    </div>

    <!-- RLS Policy Test -->
    <div class="test-section">
        <h2>üõ°Ô∏è Step 6: RLS Policies Check</h2>
        <button onclick="testRLSPolicies()">Check RLS Policies</button>
        <div id="rls-result"></div>
    </div>

    <!-- Table Structure Test -->
    <div class="test-section">
        <h2>üìä Step 7: Table Structure</h2>
        <button onclick="testTableStructure()">Check Table Columns</button>
        <div id="table-result"></div>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://faoiscbbfjtvpywmddpn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhb2lzY2JiZmp0dnB5d21kZHBuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5NDgyNzUsImV4cCI6MjA3NDUyNDI3NX0.crp_UbafreGGA_9H9berxsNYzUSijPzOuAQtC6jT044';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Check auth status on load
        checkAuthStatus();

        async function checkAuthStatus() {
            const { data: { session } } = await supabase.auth.getSession();
            const authStatus = document.getElementById('auth-status');
            const authInfo = document.getElementById('auth-info');
            
            if (session) {
                authStatus.innerHTML = '<span class="status success">‚úÖ LOGGED IN</span>';
                authInfo.innerHTML = `
                    <strong>User:</strong> ${session.user.email}<br>
                    <strong>Role:</strong> ${session.user.role}<br>
                    <strong>User ID:</strong> ${session.user.id}
                `;
            } else {
                authStatus.innerHTML = '<span class="status warning">‚ö†Ô∏è NOT LOGGED IN (Anonymous Access)</span>';
                authInfo.innerHTML = '<em>You are accessing as an anonymous user. Login to test admin functions.</em>';
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const authStatus = document.getElementById('auth-status');
            
            authStatus.innerHTML = 'Logging in...';
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                authStatus.innerHTML = `<span class="status error">‚ùå LOGIN FAILED</span><br><pre>${error.message}</pre>`;
            } else {
                await checkAuthStatus();
                alert('Login successful! You can now test admin functions.');
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            await checkAuthStatus();
            alert('Logged out successfully');
        }

        async function testConnection() {
            const result = document.getElementById('connection-result');
            result.innerHTML = '<p>Testing connection...</p>';
            
            try {
                const { data, error } = await supabase
                    .from('job_listings')
                    .select('count');
                
                if (error) {
                    result.innerHTML = `
                        <span class="status error">‚ùå CONNECTION FAILED</span>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                    `;
                } else {
                    result.innerHTML = `
                        <span class="status success">‚úÖ CONNECTION SUCCESSFUL</span>
                        <p>Database is reachable and responding</p>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <span class="status error">‚ùå ERROR</span>
                    <pre>${error.message}</pre>
                `;
            }
        }

        async function testFetchJobs() {
            const result = document.getElementById('jobs-result');
            result.innerHTML = '<p>Fetching active jobs...</p>';
            
            try {
                const { data, error } = await supabase
                    .from('job_listings')
                    .select('*')
                    .eq('is_active', true);
                
                if (error) {
                    result.innerHTML = `
                        <span class="status error">‚ùå FETCH FAILED</span>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                        <p><strong>Common Causes:</strong></p>
                        <ul>
                            <li>RLS policy missing for anonymous users</li>
                            <li>Table doesn't exist</li>
                            <li>No SELECT permission granted to 'anon' role</li>
                        </ul>
                    `;
                } else {
                    result.innerHTML = `
                        <span class="status success">‚úÖ FETCH SUCCESSFUL</span>
                        <p><strong>Active Jobs Found:</strong> ${data.length}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <span class="status error">‚ùå ERROR</span>
                    <pre>${error.message}</pre>
                `;
            }
        }

        async function testFetchAllJobs() {
            const result = document.getElementById('all-jobs-result');
            result.innerHTML = '<p>Fetching all jobs (admin access)...</p>';
            
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                result.innerHTML = '<span class="status warning">‚ö†Ô∏è You must be logged in to test this</span>';
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('job_listings')
                    .select('*');
                
                if (error) {
                    result.innerHTML = `
                        <span class="status error">‚ùå FETCH FAILED</span>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                        <p><strong>Common Causes:</strong></p>
                        <ul>
                            <li>RLS policy missing for authenticated users</li>
                            <li>No SELECT permission granted to 'authenticated' role</li>
                        </ul>
                    `;
                } else {
                    result.innerHTML = `
                        <span class="status success">‚úÖ FETCH SUCCESSFUL</span>
                        <p><strong>Total Jobs:</strong> ${data.length}</p>
                        <p><strong>Active:</strong> ${data.filter(j => j.is_active).length}</p>
                        <p><strong>Inactive:</strong> ${data.filter(j => !j.is_active).length}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <span class="status error">‚ùå ERROR</span>
                    <pre>${error.message}</pre>
                `;
            }
        }

        async function testCreateJob() {
            const result = document.getElementById('create-job-result');
            result.innerHTML = '<p>Creating test job...</p>';
            
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                result.innerHTML = '<span class="status warning">‚ö†Ô∏è You must be logged in to test this</span>';
                return;
            }
            
            const testJob = {
                title: 'TEST JOB - ' + new Date().toISOString(),
                department: 'Testing',
                location: 'Remote',
                employment_type: 'Full-time',
                description: 'This is a test job posting created by the diagnostic tool',
                requirements: 'Test requirements',
                responsibilities: 'Test responsibilities',
                skills: ['Testing', 'QA'],
                salary_range: '$50,000 - $60,000',
                experience_level: 'Entry Level',
                is_active: false, // Inactive so it doesn't show publicly
                featured: false,
                application_deadline: null
            };
            
            try {
                const { data, error } = await supabase
                    .from('job_listings')
                    .insert([testJob])
                    .select();
                
                if (error) {
                    result.innerHTML = `
                        <span class="status error">‚ùå INSERT FAILED</span>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                        <p><strong>Common Causes:</strong></p>
                        <ul>
                            <li>RLS policy missing for INSERT</li>
                            <li>No INSERT permission granted to 'authenticated' role</li>
                            <li>Missing required columns</li>
                        </ul>
                    `;
                } else {
                    result.innerHTML = `
                        <span class="status success">‚úÖ INSERT SUCCESSFUL</span>
                        <p>Test job created successfully!</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                        <p><em>Note: This job is marked as inactive so it won't appear on the public careers page</em></p>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <span class="status error">‚ùå ERROR</span>
                    <pre>${error.message}</pre>
                `;
            }
        }

        async function testRLSPolicies() {
            const result = document.getElementById('rls-result');
            result.innerHTML = '<p>Checking RLS policies...</p>';
            
            try {
                // Test 1: Can we SELECT as anonymous?
                const { error: selectError } = await supabase
                    .from('job_listings')
                    .select('id')
                    .eq('is_active', true)
                    .limit(1);
                
                const selectTest = selectError ? 
                    '<span class="status error">‚ùå Anonymous SELECT: BLOCKED</span>' :
                    '<span class="status success">‚úÖ Anonymous SELECT: ALLOWED</span>';
                
                // Test 2: Can we INSERT as anonymous?
                const { error: insertError } = await supabase
                    .from('job_applications')
                    .insert([{ 
                        full_name: 'Test',
                        email: 'test@test.com',
                        phone: '1234567890'
                    }])
                    .select();
                
                const insertTest = insertError ? 
                    '<span class="status error">‚ùå Anonymous INSERT (applications): BLOCKED</span>' :
                    '<span class="status success">‚úÖ Anonymous INSERT (applications): ALLOWED</span>';
                
                result.innerHTML = `
                    <h3>Test Results:</h3>
                    ${selectTest}<br>
                    ${insertTest}<br>
                    
                    <h3>Expected Results:</h3>
                    <ul>
                        <li>‚úÖ Anonymous users SHOULD be able to SELECT active jobs</li>
                        <li>‚úÖ Anonymous users SHOULD be able to INSERT job applications</li>
                        <li>‚ùå Anonymous users should NOT be able to INSERT jobs</li>
                    </ul>
                `;
                
                if (selectError) {
                    result.innerHTML += `
                        <h3>SELECT Error Details:</h3>
                        <pre>${JSON.stringify(selectError, null, 2)}</pre>
                    `;
                }
                
                if (insertError && insertError.code !== '42501') { // 42501 is expected permission denied
                    result.innerHTML += `
                        <h3>INSERT Error Details:</h3>
                        <pre>${JSON.stringify(insertError, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <span class="status error">‚ùå ERROR</span>
                    <pre>${error.message}</pre>
                `;
            }
        }

        async function testTableStructure() {
            const result = document.getElementById('table-result');
            result.innerHTML = '<p>Checking table structure...</p>';
            
            try {
                const { data, error } = await supabase
                    .from('job_listings')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    result.innerHTML = `
                        <span class="status error">‚ùå CANNOT ACCESS TABLE</span>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                    `;
                } else if (data && data.length > 0) {
                    const columns = Object.keys(data[0]);
                    result.innerHTML = `
                        <span class="status success">‚úÖ TABLE ACCESSIBLE</span>
                        <h3>Columns Found (${columns.length}):</h3>
                        <ul>
                            ${columns.map(col => `<li><code>${col}</code></li>`).join('')}
                        </ul>
                        <h3>Expected Columns:</h3>
                        <ul>
                            <li><code>id</code></li>
                            <li><code>title</code></li>
                            <li><code>department</code></li>
                            <li><code>location</code></li>
                            <li><code>employment_type</code></li>
                            <li><code>description</code></li>
                            <li><code>requirements</code></li>
                            <li><code>responsibilities</code></li>
                            <li><code>skills</code></li>
                            <li><code>salary_range</code></li>
                            <li><code>experience_level</code></li>
                            <li><code>is_active</code></li>
                            <li><code>featured</code></li>
                            <li><code>application_deadline</code></li>
                            <li><code>created_at</code></li>
                            <li><code>updated_at</code></li>
                        </ul>
                    `;
                } else {
                    result.innerHTML = `
                        <span class="status warning">‚ö†Ô∏è TABLE IS EMPTY</span>
                        <p>Table exists but has no data. Cannot determine column structure.</p>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <span class="status error">‚ùå ERROR</span>
                    <pre>${error.message}</pre>
                `;
            }
        }

        // Run auto-tests on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testConnection();
                testFetchJobs();
            }, 1000);
        });
    </script>
</body>
</html>
