<!DOCTYPE html>
<html>
<head>
    <title>Test Job Application Submission</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        pre {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Job Application Submission Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Check Database Connection</h2>
        <button onclick="testConnection()">Test Connection</button>
        <div id="connection-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Check if job_applications Table Exists</h2>
        <button onclick="checkTable()">Check Table</button>
        <div id="table-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Check RLS Policies</h2>
        <button onclick="checkPolicies()">Check Policies</button>
        <div id="policies-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Try Inserting Test Application</h2>
        <button onclick="testInsert()">Test Insert</button>
        <div id="insert-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 5: Check Job Listings</h2>
        <button onclick="checkJobs()">Check Jobs</button>
        <div id="jobs-result"></div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = "https://faoiscbbfjtvpywmddpn.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhb2lzY2JiZmp0dnB5d21kZHBuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5NDgyNzUsImV4cCI6MjA3NDUyNDI3NX0.crp_UbafreGGA_9H9berxsNYzUSijPzOuAQtC6jT044";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function showResult(elementId, success, message, data = null) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="result ${success ? 'success' : 'error'}">
                    <strong>${success ? '‚úÖ' : '‚ùå'} ${message}</strong>
                    ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
                </div>
            `;
        }

        async function testConnection() {
            try {
                const { data, error } = await supabase.from('job_listings').select('count');
                
                if (error) {
                    showResult('connection-result', false, 'Connection failed', error);
                } else {
                    showResult('connection-result', true, 'Connected to Supabase successfully!');
                }
            } catch (err) {
                showResult('connection-result', false, 'Connection error', { message: err.message });
            }
        }

        async function checkTable() {
            try {
                // Try to query the table
                const { data, error } = await supabase
                    .from('job_applications')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    if (error.code === '42P01') {
                        showResult('table-result', false, 'Table does NOT exist', {
                            message: 'The job_applications table has not been created yet.',
                            solution: 'Run fix-job-system-rls-only.sql in Supabase SQL Editor'
                        });
                    } else if (error.code === 'PGRST116') {
                        showResult('table-result', false, 'RLS is blocking access', {
                            message: 'Table exists but RLS policies are not set up correctly.',
                            solution: 'Run fix-job-system-rls-only.sql to set up RLS policies',
                            error: error
                        });
                    } else {
                        showResult('table-result', false, 'Error checking table', error);
                    }
                } else {
                    showResult('table-result', true, 'Table exists and is accessible!', {
                        message: 'Found ' + (data?.length || 0) + ' applications in table'
                    });
                }
            } catch (err) {
                showResult('table-result', false, 'Error', { message: err.message });
            }
        }

        async function checkPolicies() {
            try {
                // Try to read (should work for public)
                const { data: readData, error: readError } = await supabase
                    .from('job_applications')
                    .select('id')
                    .limit(1);
                
                const canRead = !readError;
                
                // Try to insert (should work for anon/public)
                const { error: insertError } = await supabase
                    .from('job_applications')
                    .insert([{
                        job_listing_id: '00000000-0000-0000-0000-000000000000', // Dummy ID
                        first_name: 'Test',
                        last_name: 'Policy',
                        email: 'test@example.com',
                        phone: '1234567890',
                        location: 'Test',
                        current_position: 'Test',
                        years_of_experience: 0,
                        expected_salary: 'Test',
                        availability: 'Test',
                        willing_to_relocate: false,
                        resume_url: '',
                        technical_skills: [],
                        soft_skills: [],
                        programming_languages: [],
                        frameworks_tools: [],
                        certifications: [],
                        languages_spoken: [],
                        work_experience: 'Test',
                        education_background: 'Test',
                        projects: 'Test',
                        achievements: 'Test',
                        cover_letter: 'Test',
                        why_interested: 'Test',
                        additional_info: 'Test'
                    }]);
                
                const canInsert = !insertError || insertError.code === '23503'; // Foreign key violation is OK for this test
                
                showResult('policies-result', canRead || canInsert, 'Policy Check Results', {
                    canRead: canRead ? '‚úÖ Yes' : '‚ùå No',
                    canInsert: canInsert ? '‚úÖ Yes (or FK error)' : '‚ùå No',
                    readError: readError ? readError.message : null,
                    insertError: insertError ? insertError.message : null,
                    note: 'Foreign key error (23503) is expected if job_listings is empty'
                });
            } catch (err) {
                showResult('policies-result', false, 'Error checking policies', { message: err.message });
            }
        }

        async function testInsert() {
            try {
                // First, get a real job_listing_id
                const { data: jobs, error: jobError } = await supabase
                    .from('job_listings')
                    .select('id')
                    .eq('is_active', true)
                    .limit(1);
                
                if (jobError || !jobs || jobs.length === 0) {
                    showResult('insert-result', false, 'No active jobs found', {
                        message: 'Need to create a job first',
                        solution: 'Run reset-and-add-sales-job.sql to create Jr Inside Sales Rep job',
                        error: jobError
                    });
                    return;
                }
                
                const jobId = jobs[0].id;
                
                // Try to insert a test application
                const testApplication = {
                    job_listing_id: jobId,
                    first_name: 'Test',
                    last_name: 'User',
                    email: 'test@example.com',
                    phone: '555-1234',
                    location: 'Test City',
                    linkedin_url: '',
                    portfolio_url: '',
                    github_url: '',
                    current_position: 'Test Position',
                    current_company: 'Test Company',
                    years_of_experience: 2,
                    expected_salary: '$50,000',
                    availability: 'Immediate',
                    willing_to_relocate: false,
                    resume_url: '',
                    technical_skills: ['JavaScript', 'React'],
                    soft_skills: ['Communication'],
                    programming_languages: ['JavaScript'],
                    frameworks_tools: ['React'],
                    certifications: [],
                    languages_spoken: ['English'],
                    work_experience: 'Test experience',
                    education_background: 'Test education',
                    projects: 'Test projects',
                    achievements: 'Test achievements',
                    cover_letter: 'Test cover letter',
                    why_interested: 'Test interest',
                    additional_info: ''
                };
                
                const { data, error } = await supabase
                    .from('job_applications')
                    .insert([testApplication])
                    .select();
                
                if (error) {
                    showResult('insert-result', false, 'Insert failed', {
                        error: error,
                        message: error.message,
                        hint: error.hint,
                        details: error.details
                    });
                } else {
                    showResult('insert-result', true, 'Test application inserted successfully!', {
                        message: 'Application ID: ' + data[0].id,
                        note: 'You can now delete this test application from admin panel'
                    });
                }
            } catch (err) {
                showResult('insert-result', false, 'Error', { message: err.message });
            }
        }

        async function checkJobs() {
            try {
                const { data, error } = await supabase
                    .from('job_listings')
                    .select('id, title, is_active, featured')
                    .eq('is_active', true);
                
                if (error) {
                    showResult('jobs-result', false, 'Error fetching jobs', error);
                } else if (!data || data.length === 0) {
                    showResult('jobs-result', false, 'No active jobs found', {
                        message: 'You need to create a job first',
                        solution: 'Run reset-and-add-sales-job.sql in Supabase SQL Editor'
                    });
                } else {
                    showResult('jobs-result', true, `Found ${data.length} active job(s)`, data);
                }
            } catch (err) {
                showResult('jobs-result', false, 'Error', { message: err.message });
            }
        }

        // Auto-run connection test on load
        window.onload = () => {
            testConnection();
        };
    </script>
</body>
</html>
